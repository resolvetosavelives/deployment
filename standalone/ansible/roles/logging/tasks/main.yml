---
- name: Logging | Generate ssh keys on servers
  openssh_keypair:
    path: ~/.ssh/id_rsa

- name: Logging | Fetch generated ssh keys
  fetch:
    src: "~/.ssh/id_rsa.pub"
    dest: "/tmp/keys/{{ inventory_hostname }}-id_rsa.pub"
    flat: yes

- name: Logging | Add servers' keys to the storage server
  authorized_key:
    key: "{% for key in query('fileglob', '/tmp/keys/*') %}{{ lookup('file', key) ~ '\n'}}{% endfor %}"
    user: "{{ deploy_user }}"
    exclusive: yes
  delegate_to: "{{ groups.storage[0] }}"

- name: Logging | Create logs directory
  file:
    path: ~/logs
    state: directory
  become: true
  become_user: "{{ deploy_user }}"
  delegate_to: "{{ groups.storage[0] }}"

- name: Logging | Set up logrotate
  template:
    src: "etc/logrotate.d/rails.j2"
    dest: "/etc/logrotate.d/rails"
    owner: root
  become: true
